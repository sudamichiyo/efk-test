name: efk-test

services:
  ### Nginx
  nginx:
    build:
      context: ./.docker/nginx
      dockerfile: Dockerfile
    container_name: nginx
    privileged: true
    restart: always
    tty: true
    environment:
      - "TZ=Asia/Tokyo"
    ports:
      - mode: ingress
        published: 80
        target: 80
        protocol: tcp
    volumes:
      - type: bind
        source: ./nginx
        target: /usr/share/nginx/html
        bind:
          create_host_path: true

  ### Fluentd
  fluentd:
    build:
      context: ./.docker/fluentd
      dockerfile: Dockerfile
    platform: linux/amd64
    container_name: fluentd
    privileged: true
    restart: always
    tty: true
    environment:
      - "TZ=Asia/Tokyo"
    ports:
      - mode: ingress
        published: 24224
        target: 24224
        protocol: tcp
      - mode: ingress
        published: 24224
        target: 24224
        protocol: udp
      - mode: ingress
        published: 5140
        target: 5140
        protocol: tcp
    volumes:
      - type: bind
        source: ./fluentd/config
        target: /fluentd/etc
        bind:
          create_host_path: true

  ### Elasticsearch
  elasticsearch:
    build:
      context: ./.docker/elasticsearch
      dockerfile: Dockerfile
    container_name: elasticsearch
    privileged: true
    restart: always
    tty: true
    environment:
      - "discovery.type=single-node"
      - "xpack.security.enabled=false"
      - "TZ=Asia/Tokyo"
    ports:
      - mode: ingress
        published: 9200
        target: 9200
        protocol: tcp

  ### Kibana
  kibana:
    build:
      context: ./.docker/kibana
      dockerfile: Dockerfile
    container_name: kibana
    privileged: true
    restart: always
    tty: true
    environment:
      - "TZ=Asia/Tokyo"
      - "i18n.locale=ja-JP"
      - "ELASTICSEARCH_HOSTS=http://elasticsearch:9200"
    ports:
      - mode: ingress
        published: 5601
        target: 5601
        protocol: tcp
